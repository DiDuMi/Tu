# 兔图项目总体实施方案

**版本**: 1.0.0
**最后更新**: 2023-11-15
**维护人**: 技术架构组

## 目录
1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [技术栈选择](#3-技术栈选择)
4. [核心功能模块](#4-核心功能模块)
5. [数据库设计](#5-数据库设计)
6. [API设计](#6-api设计)
7. [前端架构](#7-前端架构)
8. [开发计划](#8-开发计划)
9. [测试策略](#9-测试策略)
10. [部署方案](#10-部署方案)
11. [相关文档](#11-相关文档)

## 1. 项目概述

### 1.1 项目背景

兔图项目需要从Telegraph迁移到自管理解决方案，同时增强功能和用户体验。本项目将实现简化的备份方法，并添加类别管理、自动推荐、用户互动等功能。

### 1.2 项目目标

- 实现完全自主可控的内容管理平台
- 提供更丰富的用户互动功能
- 优化媒体管理和展示体验
- 实现灵活的权限控制和用户激励机制
- 确保系统性能和安全性

### 1.3 项目范围

- 用户管理与权限控制
- 内容创建、编辑和发布
- 媒体管理（本地和云媒体）
- 标签系统和分类管理
- 用户互动（评论、点赞）
- 用户激励系统（积分、签到）

## 2. 系统架构

### 2.1 整体架构

采用现代化的前后端分离架构，但使用Next.js实现前后端一体化开发：

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   客户端浏览器    |<--->|   Next.js 应用   |<--->|   数据库服务     |
|                  |     |  (前端+API路由)   |     |  (MySQL/SQLite)  |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
                               |
                               v
                         +------------------+
                         |                  |
                         |   文件存储系统   |
                         |                  |
                         +------------------+
```

### 2.2 部署架构

- 开发环境：本地开发服务器
- 测试环境：测试服务器
- 生产环境：宝塔面板部署，端口3001

## 3. 技术栈选择

### 3.1 前端技术栈

- **框架**: Next.js 14+ (Pages Router)
  - **必须使用Pages Router架构**，严格禁止使用App Router
  - 选择Pages Router的原因：稳定性、团队熟悉度、兼容性、降低学习成本、减少迁移风险
- **样式方案**: Tailwind CSS
  - **严格禁止使用Ant Design组件**
  - 所有UI组件必须使用Tailwind CSS构建
  - 可以使用基于Tailwind CSS的组件库（如Headless UI、Radix UI）
- **状态管理**: Zustand
  - **严格禁止使用React Context API进行状态管理**
  - 所有全局状态必须使用Zustand管理
  - 组件内部状态使用React useState和useReducer
- **数据获取**: SWR
  - 所有客户端数据获取必须使用SWR
  - 服务端数据获取可以直接使用fetch API

### 3.2 后端技术栈

- **API框架**: Next.js Route Handlers
  - 所有API端点必须使用Next.js Route Handlers实现
  - API路由必须遵循RESTful设计原则
- **数据库ORM**: Prisma 5+
  - 所有数据库操作必须通过Prisma进行
  - 禁止直接编写SQL查询（除非有特殊性能需求并经过审核）
- **认证**: NextAuth.js v4.24.5
  - **必须使用v4.24.5版本**，不得升级或降级
  - 所有认证相关功能必须通过NextAuth.js实现
- **验证**: Zod
  - 所有API输入必须使用Zod进行验证
  - 前端表单验证也推荐使用Zod
- **文件处理**: Sharp (图片处理)
  - 所有服务端图片处理必须使用Sharp

### 3.3 开发语言与工具

- **语言**: TypeScript 5+
  - 所有代码文件必须使用TypeScript编写
  - 禁止使用any类型，除非有特殊情况并添加注释说明
- **代码质量**: ESLint, Prettier
  - 所有代码必须通过ESLint检查和Prettier格式化
  - 提交前必须运行lint检查
- **版本控制**: Git, GitHub
  - 使用GitHub Flow工作流
  - 所有功能开发必须在feature分支进行
- **CI/CD**: GitHub Actions
  - 所有提交必须通过CI检查
  - 部署必须通过CD流程进行

## 4. 核心功能模块

### 4.1 用户管理模块

- 用户注册与登录
- 六级用户组权限体系
- 用户账号管理
- 用户审核流程
- 权限控制机制

详见 [用户管理实施方案](./用户管理实施方案.md)

### 4.2 内容管理模块

- TinyMCE编辑器集成
- 媒体管理（本地和云媒体）
- 标签系统
- 内容创建、编辑和发布
- 内容预览限制

详见 [内容管理实施方案](./内容管理实施方案.md)

### 4.3 媒体管理模块

- 本地媒体上传与处理
- 云媒体支持
- 媒体压缩与优化
- 媒体排序功能
- 用户组上传限制

详见 [媒体管理实施方案](./媒体管理实施方案.md)

### 4.4 用户激励模块

- 积分系统
- 签到功能
- 积分兑换系统
- 特权管理

详见 [用户激励实施方案](./用户激励实施方案.md)

## 5. 数据库设计

### 5.1 数据库选择

- 开发环境：SQLite
- 生产环境：MySQL 8.0+

### 5.2 数据模型设计

采用统一的数据模型设计，包括：

- 用户相关模型
- 内容相关模型
- 互动相关模型
- 媒体相关模型
- 积分与激励模型

详见 [数据模型实施方案](./数据模型实施方案.md)

## 6. API设计

### 6.1 API设计原则

- 采用RESTful API设计风格
- 使用版本控制（/api/v1/）
- 实现API缓存机制提高性能

### 6.2 API响应格式规范

所有API响应必须遵循以下统一格式：

```json
// 成功响应
{
  "success": true,
  "data": {
    // 响应数据，根据API不同而不同
  },
  "message": "操作成功" // 可选
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述信息"
  }
}
```

分页数据的统一格式：

```json
{
  "success": true,
  "data": {
    "items": [...], // 数据项数组
    "total": 100,   // 总数据条数
    "page": 1,      // 当前页码
    "limit": 10     // 每页条数
  }
}
```

### 6.3 认证与安全

- 使用JWT令牌认证
- 实现CSRF保护
- 请求参数验证和清理
- 权限控制中间件

## 7. 前端架构

### 7.1 页面组织

- **必须采用Pages Router架构**（严格禁止使用App Router）
  - 所有页面组件放在pages/目录下
  - API路由放在pages/api/目录下
  - 遵循Next.js的Pages Router约定
- 按功能模块组织目录结构
- 实现组件复用和模块化

### 7.2 状态管理

- **必须使用Zustand作为唯一的状态管理解决方案**（严格禁止使用React Context API）
  - 按功能域划分store（用户、产品、内容等）
  - 使用选择性订阅提高性能
  - 使用中间件增强功能（devtools、persist等）
- 遵循Zustand的最佳实践和设计模式
- 使用SWR进行数据获取和缓存
  - 利用SWR的自动重新验证和错误重试机制
  - 实现乐观更新提升用户体验

### 7.3 UI设计

- **必须基于Tailwind CSS构建UI组件**（严格禁止使用Ant Design）
  - 创建基础UI组件库，替代Ant Design组件
  - 使用Tailwind的工具类实现一致的设计系统
  - 可以使用基于Tailwind的组件库（如Headless UI）
- 实现响应式设计
  - 使用Tailwind的响应式前缀（sm:, md:, lg:等）
  - 移动优先的设计方法
- 支持主题切换
  - 使用Tailwind的暗模式支持
  - 实现自定义主题配置
- 优化移动端体验
  - 适配不同屏幕尺寸
  - 优化触摸交互

## 8. 开发计划

### 8.1 开发阶段

| 阶段 | 时间 | 主要任务 |
|------|------|---------|
| 阶段一 | 2周 | 基础架构搭建、数据库模型设计、认证系统实现 |
| 阶段二 | 3周 | 用户管理功能开发、权限系统实现 |
| 阶段三 | 4周 | 内容管理功能开发、编辑器集成、媒体管理 |
| 阶段四 | 3周 | 用户激励系统、互动功能开发 |
| 阶段五 | 2周 | 测试、优化、文档编写 |

### 8.2 里程碑

| 里程碑 | 时间 | 交付物 |
|-------|------|-------|
| M1 | 第2周末 | 基础架构和数据模型完成 |
| M2 | 第5周末 | 用户管理模块完成 |
| M3 | 第9周末 | 内容管理模块完成 |
| M4 | 第12周末 | 用户激励和互动功能完成 |
| M5 | 第14周末 | 系统测试通过，准备部署 |

### 8.3 任务分配

| 模块 | 负责人 | 开发时间 | 测试时间 |
|------|-------|---------|---------|
| 用户管理 | 开发者A | 3周 | 1周 |
| 内容管理 | 开发者B | 4周 | 1周 |
| 媒体管理 | 开发者C | 3周 | 1周 |
| 用户激励 | 开发者D | 3周 | 1周 |

## 9. 测试策略

### 9.1 测试类型

- 单元测试：测试独立组件和函数
- 集成测试：测试模块间交互
- 端到端测试：测试完整用户流程
- 性能测试：测试系统性能和响应时间

### 9.2 测试工具

- Jest：单元测试框架
- React Testing Library：组件测试
- Cypress：端到端测试
- Lighthouse：性能测试

### 9.3 测试流程

1. 开发人员编写单元测试
2. 提交代码前运行测试
3. CI/CD流程中自动运行测试
4. 测试团队进行手动测试
5. 修复发现的问题并重新测试

## 10. 部署方案

### 10.1 部署环境

- 服务器：宝塔面板管理的服务器
- 端口：3001
- 数据库：MySQL 8.0+

### 10.2 部署流程

1. 准备服务器环境
2. 配置数据库
3. 构建Next.js应用
4. 配置反向代理
5. 设置自动备份
6. 监控系统运行状态

### 10.3 备份策略

- 数据库每日自动备份
- 文件系统定期备份
- 备份文件存储在安全位置
- 定期测试恢复流程

## 11. 相关文档

- [数据模型实施方案](./数据模型实施方案.md)
- [用户管理实施方案](./用户管理实施方案.md)
- [内容管理实施方案](./内容管理实施方案.md)
- [媒体管理实施方案](./媒体管理实施方案.md)
- [用户激励实施方案](./用户激励实施方案.md)
- [功能增强实施方案](./功能增强实施方案.md)
- [测试策略实施方案](./测试策略实施方案.md)
- [重构实施方案](./重构实施方案.md)
- [技术架构实施方案](./技术架构实施方案.md)
- [功能规划实施方案](./功能规划实施方案.md)
- [Ant Design到Tailwind CSS迁移指南](./Ant%20Design到Tailwind%20CSS迁移指南.md)
- [React Context API到Zustand迁移指南](./React%20Context%20API到Zustand迁移指南.md)
- [兔图项目新手入门指南](./兔图项目新手入门指南.md)
- [文档版本控制与更新规范](./文档版本控制与更新规范.md)

## 版本历史

| 版本 | 日期 | 更新内容 | 更新人 |
|-----|------|---------|-------|
| 1.0.0 | 2023-11-15 | 初始版本 | 技术架构组 |
