# 首页分类权限控制功能说明

## 功能概述

首页分类权限控制功能允许管理员为不同的用户组设置首页分类发布权限，实现精细化的内容发布控制。该功能确保只有拥有相应权限的用户才能将内容发布到首页的特定分类中。

## 核心特性

### 1. 细粒度权限控制
- 支持四个首页分类的独立权限设置：精选内容、近期流出、往期补档、热门推荐
- 每个用户组可以独立配置对这四个分类的发布权限
- 权限变更立即生效，无需重启系统

### 2. 多层权限验证
- **前端验证**: 根据用户权限动态显示可选的分类选项
- **API验证**: 在内容创建和编辑时验证用户权限
- **数据库约束**: 确保数据一致性和安全性

### 3. 智能权限继承
- 管理员和操作员默认拥有所有首页分类权限
- 普通用户组默认没有首页分类权限
- 支持基于用户角色的权限预设

## 技术实现

### 权限系统架构

```
用户 (User) 
  ↓ 
用户组 (UserGroup) 
  ↓ 
权限配置 (permissions.homepage) 
  ↓ 
首页分类权限 (featured, latest, archive, trending)
```

### 核心组件

#### 1. 权限验证工具 (`lib/homepage-permissions.ts`)
```typescript
// 检查用户是否有权限发布到指定首页分类
hasHomepagePublishPermission(session, categorySlug)

// 获取用户可以发布的首页分类列表
getAvailableHomepageCategories(session)

// 检查分类是否是首页分类
isHomepageCategory(categorySlug)
```

#### 2. 前端权限Hook (`hooks/useHomepagePermissions.ts`)
```typescript
// 获取用户可用的分类列表
const { availableCategories, canPublishToCategory } = useHomepagePermissions(categories)

// 获取用户的首页权限
const { permissions, hasPermission } = useUserHomepagePermissions()
```

#### 3. 权限配置组件 (`components/user-groups/PermissionSelector.tsx`)
- 在用户组管理页面提供首页分类权限配置界面
- 使用复选框形式让管理员直观地设置权限
- 实时更新权限配置

#### 4. 内容表单组件 (`components/content/form/ContentForm.tsx`)
- 根据用户权限动态过滤可选分类
- 显示权限提示信息
- 标识首页分类

## 权限配置

### 默认权限设置

| 用户组 | 精选内容 | 近期流出 | 往期补档 | 热门推荐 |
|--------|----------|----------|----------|----------|
| 管理员 | ✅ | ✅ | ✅ | ✅ |
| 操作员 | ✅ | ✅ | ✅ | ✅ |
| 年度会员 | ❌ | ✅ | ❌ | ❌ |
| 月度会员 | ❌ | ❌ | ❌ | ❌ |
| 注册用户 | ❌ | ❌ | ❌ | ❌ |

### 权限操作映射

```json
{
  "homepage": {
    "featured": "精选内容分类权限",
    "latest": "近期流出分类权限", 
    "archive": "往期补档分类权限",
    "trending": "热门推荐分类权限"
  }
}
```

## 使用指南

### 管理员操作

#### 1. 配置用户组权限
1. 访问 `/admin/user-groups` 用户组管理页面
2. 选择要编辑的用户组
3. 在权限配置区域找到"首页分类发布"部分
4. 勾选或取消勾选相应的首页分类权限
5. 保存配置

#### 2. 查看权限效果
1. 访问 `/admin/content/create` 内容创建页面
2. 使用不同权限的用户账户登录
3. 观察分类下拉菜单中显示的选项差异

### 用户操作

#### 1. 创建内容
1. 访问内容创建页面
2. 在分类选择中只能看到有权限的首页分类
3. 首页分类会标注"(首页分类)"标识
4. 如果权限不足，会显示相应提示

#### 2. 编辑内容
1. 编辑现有内容时同样受权限限制
2. 如果当前内容的分类超出权限范围，会收到错误提示
3. 需要联系管理员调整权限或更改分类

## API接口

### 权限验证端点

#### 创建内容 `POST /api/v1/pages`
- 验证用户是否有权限发布到指定分类
- 返回403错误如果权限不足

#### 编辑内容 `PUT /api/v1/pages/[id]`
- 验证分类变更权限
- 保护现有内容不被非法修改

### 错误响应示例

```json
{
  "success": false,
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "您没有权限发布内容到\"精选内容\"分类"
  }
}
```

## 安全考虑

### 1. 多层验证
- 前端验证提供用户体验
- 后端验证确保安全性
- 数据库约束防止数据污染

### 2. 权限隔离
- 不同用户组之间权限完全隔离
- 权限变更不影响现有内容
- 支持权限回收和重新分配

### 3. 审计追踪
- 权限变更记录在系统日志中
- 内容发布操作可追溯
- 支持权限使用情况分析

## 故障排除

### 常见问题

#### Q: 用户看不到首页分类选项
A: 检查用户所属用户组的首页分类权限配置

#### Q: API返回权限拒绝错误
A: 确认用户有权限发布到指定的首页分类

#### Q: 权限配置不生效
A: 检查用户组权限配置是否正确保存，用户是否属于正确的用户组

### 调试步骤

1. 检查用户组权限配置
2. 验证用户所属用户组
3. 确认分类slug映射正确
4. 查看API错误日志

## 扩展功能

### 未来增强

1. **时间限制权限**: 支持权限的时间窗口限制
2. **内容数量限制**: 限制用户在首页分类中的内容数量
3. **审核流程**: 为首页分类内容添加专门的审核流程
4. **权限模板**: 提供预设的权限模板快速配置

### 集成建议

1. 与现有的内容审核系统集成
2. 添加权限使用统计和分析
3. 支持批量权限操作
4. 提供权限变更通知机制

## 更新日志

- **v1.0.0**: 初始版本，实现基础的首页分类权限控制
  - 支持四个首页分类的权限配置
  - 前端动态权限控制
  - API层权限验证
  - 用户组权限管理界面
  - 完整的文档和测试
