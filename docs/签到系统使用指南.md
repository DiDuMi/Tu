# å…”å›¾ç­¾åˆ°ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

å…”å›¾ç­¾åˆ°ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„å¤šæ¸ é“ç­¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒç½‘é¡µç­¾åˆ°ã€APIé›†æˆå’Œå¤–éƒ¨ç¨‹åºï¼ˆå¦‚Telegram Botï¼‰ç­¾åˆ°ã€‚ç³»ç»Ÿæä¾›ä¸°å¯Œçš„ç»Ÿè®¡åˆ†æåŠŸèƒ½å’Œå®‰å…¨çš„APIå¯†é’¥ç®¡ç†ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç½‘é¡µç­¾åˆ°
1. ç™»å½•å…”å›¾å¹³å°
2. è®¿é—® `http://localhost:3000/dashboard/signin`
3. ç‚¹å‡»"ç«‹å³ç­¾åˆ°"æŒ‰é’®å®Œæˆæ¯æ—¥ç­¾åˆ°
4. æŸ¥çœ‹ç­¾åˆ°ç»Ÿè®¡å’Œç§¯åˆ†ä¿¡æ¯

### 2. APIå¯†é’¥ç®¡ç†
1. è®¿é—® `http://localhost:3000/dashboard/api-keys`
2. ç‚¹å‡»"åˆ›å»ºAPIå¯†é’¥"
3. å¡«å†™å¯†é’¥åç§°å’Œæƒé™
4. ä¿å­˜ç”Ÿæˆçš„APIå¯†é’¥ï¼ˆä»…æ˜¾ç¤ºä¸€æ¬¡ï¼‰

### 3. å¤–éƒ¨ç¨‹åºé›†æˆ
ä½¿ç”¨APIå¯†é’¥è°ƒç”¨å¤–éƒ¨ç­¾åˆ°æ¥å£ï¼Œå®ç°Telegram Botç­‰ç¨‹åºçš„ç­¾åˆ°åŠŸèƒ½ã€‚

## ğŸ“‹ APIæ¥å£æ–‡æ¡£

### 1. APIå¯†é’¥ç®¡ç†

#### è·å–APIå¯†é’¥åˆ—è¡¨
```http
GET /api/v1/users/me/api-keys
Authorization: éœ€è¦ç™»å½•çŠ¶æ€
```

#### åˆ›å»ºAPIå¯†é’¥
```http
POST /api/v1/users/me/api-keys
Content-Type: application/json

{
  "keyName": "Telegram Bot",
  "permissions": ["signin", "read_profile"],
  "expiresAt": "2024-12-31T23:59:59Z"
}
```

#### åˆ é™¤APIå¯†é’¥
```http
DELETE /api/v1/users/me/api-keys
Content-Type: application/json

{
  "keyId": "api-key-uuid"
}
```

### 2. å¤–éƒ¨ç­¾åˆ°API

#### å¤–éƒ¨ç¨‹åºç­¾åˆ°
```http
POST /api/v1/signin/external
Content-Type: application/json

{
  "api_key": "your_api_key_here",
  "user_identifier": "telegram:123456789",
  "source": "telegram_bot",
  "extra_data": {
    "telegram_user_id": "123456789",
    "chat_id": "-1001234567890"
  }
}
```

**ç”¨æˆ·æ ‡è¯†ç¬¦æ ¼å¼ï¼š**
- Telegramç”¨æˆ·ï¼š`telegram:123456789`
- é‚®ç®±ç”¨æˆ·ï¼š`user@example.com`
- ç”¨æˆ·IDï¼š`123`

**å“åº”æ ¼å¼ï¼š**
```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "continuous_days": 5,
    "points_earned": 10,
    "current_points": 150,
    "source": "telegram_bot",
    "rewards": [
      {
        "type": "points",
        "amount": 10,
        "reason": "è¿ç»­ç­¾åˆ°5å¤©å¥–åŠ±"
      }
    ]
  },
  "message": "ç­¾åˆ°æˆåŠŸ"
}
```

### 3. ç­¾åˆ°ç»Ÿè®¡API

#### è·å–ç”¨æˆ·ç­¾åˆ°ç»Ÿè®¡
```http
GET /api/v1/users/me/signin/stats
Authorization: éœ€è¦ç™»å½•çŠ¶æ€
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "user_stats": {
      "total_sign_ins": 45,
      "current_streak": 7,
      "longest_streak": 15,
      "total_points_from_signin": 350,
      "sign_in_rate": 0.85,
      "favorite_time": "09:00-10:00",
      "sources": {
        "web": 30,
        "telegram_bot": 15
      }
    },
    "monthly_calendar": {
      "2024-01": [1, 2, 3, 5, 6, 7, 8, 10]
    },
    "recent_records": [...]
  }
}
```

## ğŸ¤– Telegram Boté›†æˆç¤ºä¾‹

### Pythonå®ç°
```python
import aiohttp
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler

class TuTuSignInBot:
    def __init__(self, bot_token: str, api_base_url: str, api_key: str):
        self.bot_token = bot_token
        self.api_base_url = api_base_url
        self.api_key = api_key
    
    async def signin_callback(self, update: Update, context):
        query = update.callback_query
        await query.answer()
        
        user_id = query.from_user.id
        
        # è°ƒç”¨å…”å›¾ç­¾åˆ°API
        result = await self.call_signin_api(user_id, query.message.chat.id)
        
        if result['success']:
            data = result['data']
            message = f"""
âœ… ç­¾åˆ°æˆåŠŸï¼

ğŸ¯ è¿ç»­ç­¾åˆ°ï¼š{data['continuous_days']} å¤©
ğŸ’ è·å¾—ç§¯åˆ†ï¼š{data['points_earned']} åˆ†
ğŸ’° å½“å‰ç§¯åˆ†ï¼š{data['current_points']} åˆ†
            """
        else:
            message = f"âŒ ç­¾åˆ°å¤±è´¥ï¼š{result.get('message', 'æœªçŸ¥é”™è¯¯')}"
        
        await query.edit_message_text(message)
    
    async def call_signin_api(self, telegram_user_id: int, chat_id: int):
        url = f"{self.api_base_url}/api/v1/signin/external"
        payload = {
            "api_key": self.api_key,
            "user_identifier": f"telegram:{telegram_user_id}",
            "source": "telegram_bot",
            "extra_data": {
                "telegram_user_id": str(telegram_user_id),
                "chat_id": str(chat_id)
            }
        }
        
        async with aiohttp.ClientSession() as session:
            async with session.post(url, json=payload) as response:
                return await response.json()

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    BOT_TOKEN = "your_telegram_bot_token"
    API_BASE_URL = "http://localhost:3000"
    API_KEY = "your_api_key_from_tutu_platform"
    
    bot = TuTuSignInBot(BOT_TOKEN, API_BASE_URL, API_KEY)
    application = Application.builder().token(BOT_TOKEN).build()
    
    application.add_handler(CallbackQueryHandler(bot.signin_callback, pattern="signin"))
    await application.run_polling()

if __name__ == "__main__":
    asyncio.run(main())
```

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. APIå¯†é’¥å®‰å…¨
- **åŠ å¯†å­˜å‚¨**ï¼šAPIå¯†é’¥ä½¿ç”¨SHA256åŠ å¯†å­˜å‚¨
- **æƒé™æ§åˆ¶**ï¼šæ”¯æŒç»†ç²’åº¦æƒé™é…ç½®
- **è¿‡æœŸç®¡ç†**ï¼šå¯è®¾ç½®å¯†é’¥è¿‡æœŸæ—¶é—´
- **ä½¿ç”¨ç›‘æ§**ï¼šè®°å½•ä½¿ç”¨æ¬¡æ•°å’Œæœ€åä½¿ç”¨æ—¶é—´

### 2. ç­¾åˆ°å®‰å…¨
- **é‡å¤é˜²æŠ¤**ï¼šé˜²æ­¢åŒä¸€å¤©é‡å¤ç­¾åˆ°
- **æƒé™éªŒè¯**ï¼šéªŒè¯APIå¯†é’¥æƒé™
- **ç”¨æˆ·éªŒè¯**ï¼šç¡®è®¤ç”¨æˆ·çŠ¶æ€å’Œèº«ä»½
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•ç­¾åˆ°æ¥æºå’Œè®¾å¤‡ä¿¡æ¯

## ğŸ“Š æ•°æ®ç»Ÿè®¡åŠŸèƒ½

### 1. åŸºç¡€ç»Ÿè®¡
- æ€»ç­¾åˆ°æ¬¡æ•°
- å½“å‰è¿ç»­ç­¾åˆ°å¤©æ•°
- æœ€é•¿è¿ç»­ç­¾åˆ°è®°å½•
- ç­¾åˆ°è·å¾—çš„æ€»ç§¯åˆ†

### 2. é«˜çº§åˆ†æ
- 30å¤©ç­¾åˆ°ç‡è®¡ç®—
- æœ€å¸¸ç­¾åˆ°æ—¶é—´æ®µåˆ†æ
- æŒ‰æ¥æºåˆ†ç±»çš„ç­¾åˆ°ç»Ÿè®¡
- æœˆåº¦ç­¾åˆ°æ—¥å†å±•ç¤º

### 3. å¯è§†åŒ–å±•ç¤º
- ç»Ÿè®¡å¡ç‰‡å±•ç¤ºå…³é”®æŒ‡æ ‡
- ç­¾åˆ°æ¥æºé¥¼å›¾åˆ†æ
- è¿ç»­ç­¾åˆ°è¶‹åŠ¿å›¾
- ç§¯åˆ†è·å¾—å†å²è®°å½•

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### 1. ç¯å¢ƒè¦æ±‚
- Node.js 18+
- Next.js 14+
- Prisma 5+
- TypeScript 5+

### 2. æœ¬åœ°å¼€å‘
```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# è®¿é—®åº”ç”¨
http://localhost:3000
```

### 3. æ•°æ®åº“é…ç½®
```bash
# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate dev
```

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®
- é…ç½®ç¯å¢ƒå˜é‡
- è®¾ç½®æ•°æ®åº“è¿æ¥
- é…ç½®APIå¯†é’¥åŠ å¯†ç›å€¼
- å¯ç”¨HTTPS

### 2. ç›‘æ§å’Œç»´æŠ¤
- APIè°ƒç”¨ç›‘æ§
- é”™è¯¯æ—¥å¿—æ”¶é›†
- æ€§èƒ½æŒ‡æ ‡è·Ÿè¸ª
- å®šæœŸæ•°æ®å¤‡ä»½

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
2. æ£€æŸ¥APIå“åº”é”™è¯¯ä¿¡æ¯
3. æŸ¥çœ‹å¼€å‘è€…æ§åˆ¶å°æ—¥å¿—
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

## ğŸ‰ æ€»ç»“

å…”å›¾ç­¾åˆ°ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„å¤šæ¸ é“ç­¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ç®€å•çš„APIé›†æˆå³å¯å®ç°ï¼š

- âœ… å¤šå¹³å°ç­¾åˆ°æ”¯æŒ
- âœ… ä¸°å¯Œçš„æ•°æ®ç»Ÿè®¡
- âœ… å®‰å…¨çš„æƒé™ç®¡ç†
- âœ… çµæ´»çš„æ‰©å±•èƒ½åŠ›

å¼€å§‹ä½¿ç”¨å…”å›¾ç­¾åˆ°ç³»ç»Ÿï¼Œæå‡ç”¨æˆ·å‚ä¸åº¦å’Œå¹³å°æ´»è·ƒåº¦ï¼
