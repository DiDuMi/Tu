# 问题修复和游客权限系统说明

## 问题1修复：操作员"提交审核"后内容不显示

### 问题分析
操作员提交审核后，管理员在内容管理页面看不到相关内容，主要原因是：

1. **状态映射不一致**：内容创建页面使用`'REVIEW'`状态，但StatusBadge组件只支持`'PENDING'`状态
2. **审核按钮条件错误**：管理员审核按钮只检查`'REVIEW'`状态和`'ADMIN'`角色
3. **API路径混淆**：用户内容管理页面使用`/api/v1/users/me/contents`，管理员应使用`/admin/content`页面

### 修复方案

#### 1. 统一状态映射
**修复文件**: `pages/dashboard/contents/index.tsx`

```typescript
const statusMap: Record<string, { label: string; className: string }> = {
  DRAFT: { label: '草稿', className: 'bg-gray-100 text-gray-800' },
  PENDING: { label: '待审核', className: 'bg-yellow-100 text-yellow-800' },
  REVIEW: { label: '待审核', className: 'bg-yellow-100 text-yellow-800' }, // 新增
  PUBLISHED: { label: '已发布', className: 'bg-green-100 text-green-800' },
  REJECTED: { label: '已拒绝', className: 'bg-red-100 text-red-800' },
  ARCHIVED: { label: '已归档', className: 'bg-blue-100 text-blue-800' },
}
```

#### 2. 修复审核按钮条件
```typescript
{(content.status === 'REVIEW' || content.status === 'PENDING') && 
 (session?.user?.role === 'ADMIN' || session?.user?.role === 'OPERATOR') && (
  // 审核按钮
)}
```

#### 3. 页面访问指导
- **用户内容管理**: `/dashboard/contents` - 查看自己的内容
- **管理员内容管理**: `/admin/content` - 查看所有用户的内容
- **内容审核**: `/admin/content/review` - 专门的审核页面

### 验证方法
1. 操作员在`/dashboard/contents/create`创建内容并提交审核
2. 管理员在`/admin/content`或`/admin/content/review`查看待审核内容
3. 管理员可以通过并发布或拒绝内容

## 问题2解决：游客权限系统

### 问题分析
用户组里没有"游客"用户组，因为游客是指未注册或未登录的用户，他们不属于任何用户组。需要单独的权限管理机制。

### 解决方案：游客权限系统

#### 1. 游客权限配置
**文件**: `lib/homepage-permissions.ts`

```typescript
export const GUEST_PERMISSIONS = {
  canView: true,                    // 可以查看内容
  canSearch: true,                  // 可以搜索内容
  allowedStatuses: ['PUBLISHED'],   // 只能查看已发布内容
  canCreateContent: false,          // 不能创建内容
  canComment: false,                // 不能评论
  canLike: false,                   // 不能点赞
  canFavorite: false,               // 不能收藏
  previewPercentage: 30,            // 内容预览30%
  canPlayVideo: false               // 不能播放视频
}
```

#### 2. 游客权限管理页面
**文件**: `pages/admin/settings/guest-permissions.tsx`

管理员可以通过此页面配置：
- 基础权限（查看、搜索、视频播放）
- 内容权限（可查看的状态、预览百分比）
- 互动权限（创建、评论、点赞、收藏）

#### 3. 游客权限API
**文件**: `pages/api/v1/settings/guest-permissions.ts`

- `GET /api/v1/settings/guest-permissions` - 获取游客权限设置
- `PUT /api/v1/settings/guest-permissions` - 更新游客权限设置

#### 4. 权限验证函数
```typescript
// 检查游客是否有指定权限
export function hasGuestPermission(permission: keyof typeof GUEST_PERMISSIONS): boolean

// 获取游客的内容预览百分比
export function getGuestPreviewPercentage(): number

// 检查游客是否可以查看指定状态的内容
export function canGuestViewStatus(status: string): boolean
```

### 使用方法

#### 管理员配置游客权限
1. 访问 `/admin/settings/guest-permissions`
2. 配置各项权限设置
3. 保存配置

#### 系统权限验证
```typescript
// 在API或组件中检查权限
if (!session) {
  // 游客用户
  if (!hasGuestPermission('canView')) {
    return errorResponse(res, 'PERMISSION_DENIED', '游客无权查看内容')
  }
} else {
  // 已登录用户，使用用户组权限
  // ...
}
```

### 权限层级

1. **游客** (未登录)
   - 使用 `GUEST_PERMISSIONS` 配置
   - 权限最低，主要用于内容浏览

2. **注册用户** (已登录)
   - 使用用户组权限配置
   - 可以有不同等级的权限

3. **管理员/操作员**
   - 拥有最高权限
   - 可以管理游客权限配置

## 技术实现细节

### 权限检查流程
```typescript
function checkPermission(session, action) {
  if (!session) {
    // 游客权限检查
    return hasGuestPermission(action)
  } else {
    // 用户组权限检查
    return hasUserGroupPermission(session.user.userGroup, action)
  }
}
```

### 数据存储
- 游客权限配置存储在 `SystemSetting` 表中
- key: `'guest_permissions'`
- value: JSON格式的权限配置
- 支持动态更新，无需重启系统

### 日志记录
- 所有游客权限配置变更都会记录在系统日志中
- 包含操作者信息和变更详情
- 便于审计和问题排查

## 总结

通过这次修复和改进：

1. **解决了审核流程问题**：操作员提交审核的内容现在可以正确显示给管理员
2. **建立了游客权限系统**：为未登录用户提供了完整的权限管理机制
3. **提供了管理界面**：管理员可以方便地配置游客权限
4. **完善了权限验证**：系统现在支持游客、注册用户、管理员三级权限体系

这个解决方案既解决了当前的问题，又为未来的权限管理提供了扩展性。
