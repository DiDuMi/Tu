# 📋 媒体文件去重机制详细实施计划

## 🎯 实施概览

**总体时间估算**：8-12个工作日
**风险等级**：中等（开发环境，可重置数据）
**实施方式**：分阶段渐进式部署

## 📅 详细实施计划

### 阶段1：数据库模式设计与迁移（第1-2天）

#### 1.1 数据库模式更新 ⏱️ 2小时 | 🔴 低风险 ✅ 已完成

**任务**：
- [x] 添加FileHash模型到Prisma schema
- [x] 更新Media模型，添加fileHashId字段
- [x] 生成并应用数据库迁移

**执行步骤**：
```bash
# 1. 应用数据库模式更改
npx prisma db push --force-reset

# 2. 验证数据库结构
npx prisma studio
```

**验证标准**：
- ✅ FileHash表成功创建
- ✅ Media表包含fileHashId字段
- ✅ 所有索引正确创建

#### 1.2 清理现有数据 ⏱️ 1小时 | 🟡 中风险 ✅ 已完成

**任务**：
- [x] 运行数据清理脚本
- [x] 创建新的目录结构

**执行步骤**：
```bash
# 运行迁移脚本
npx tsx scripts/migrate-to-deduplication.ts
```

**验证标准**：
- ✅ 所有媒体记录已删除（0条记录）
- ✅ 上传目录已清理（删除267个文件）
- ✅ 新目录结构已创建（131,587个目录）

### 阶段2：核心去重逻辑开发（第3-5天）

#### 2.1 文件去重工具库 ⏱️ 1天 | 🔴 低风险 ✅ 已完成

**任务**：
- [x] 创建file-deduplication.ts工具库
- [x] 实现哈希计算功能
- [x] 实现引用计数管理

**文件**：`lib/file-deduplication.ts`

**验证标准**：
- ✅ 哈希计算功能正常
- ✅ 文件查找功能正常
- ✅ 引用计数管理正确

#### 2.2 去重上传逻辑 ⏱️ 1.5天 | 🟡 中风险 ✅ 已完成

**任务**：
- [x] 创建media-upload-dedup.ts
- [x] 实现去重上传流程
- [x] 集成现有媒体处理功能

**文件**：`lib/media-upload-dedup.ts`

**验证标准**：
- ✅ 新文件正常处理
- ✅ 重复文件正确去重
- ✅ 媒体处理功能完整

#### 2.3 API接口更新 ⏱️ 1.5天 | 🟡 中风险 ✅ 已完成

**任务**：
- [x] 更新上传API使用去重逻辑
- [x] 更新MediaUploadResponse类型
- [x] 添加去重统计API
- [x] 保持向后兼容性

**已修改的文件**：
- ✅ `pages/api/v1/media/upload.ts` - 集成去重上传
- ✅ `types/api.ts` - 添加去重响应字段
- ✅ `pages/api/v1/media/deduplication-stats.ts` - 新增统计API

### 阶段3：前端组件适配（第6-7天）

#### 3.1 上传组件更新 ⏱️ 1天 | 🔴 低风险

**任务**：
- [ ] 更新MediaUploader组件
- [ ] 添加去重状态显示
- [ ] 更新进度提示

**需要修改的文件**：
- `components/media/MediaUploader.tsx`
- `hooks/useMediaUpload.ts`

#### 3.2 媒体管理界面 ⏱️ 0.5天 | 🔴 低风险

**任务**：
- [ ] 添加去重统计显示
- [ ] 更新媒体列表组件
- [ ] 添加存储空间节省提示

### 阶段4：测试与验证（第8-9天）

#### 4.1 单元测试 ⏱️ 1天 | 🔴 低风险 ✅ 已完成

**任务**：
- [x] 创建去重功能测试脚本
- [x] 测试核心去重逻辑
- [x] 验证引用计数管理

**执行步骤**：
```bash
# 运行核心功能测试
npx tsx scripts/test-deduplication.ts
```

**测试结果**：
- ✅ 6个测试全部通过（100%成功率）
- ✅ 文件哈希计算正常
- ✅ 去重功能正常工作
- ✅ 引用计数管理正确
- ✅ 统计信息获取正常

#### 4.2 集成测试 ⏱️ 1天 | 🟡 中风险 🔄 进行中

**任务**：
- [x] 创建API测试脚本
- [ ] 测试完整上传流程
- [ ] 测试删除流程
- [ ] 测试并发上传

**已创建文件**：
- ✅ `scripts/test-upload-api.ts` - API集成测试脚本

### 阶段5：性能优化与监控（第10-12天）

#### 5.1 性能优化 ⏱️ 1天 | 🔴 低风险

**任务**：
- [ ] 优化哈希计算性能
- [ ] 添加缓存机制
- [ ] 优化数据库查询

#### 5.2 监控与统计 ⏱️ 1天 | 🔴 低风险

**任务**：
- [ ] 添加去重统计API
- [ ] 创建管理后台统计页面
- [ ] 添加性能监控

## 🔧 具体执行命令

### 数据库迁移
```bash
# 1. 生成迁移
npx prisma migrate dev --name add-file-deduplication

# 2. 应用到数据库
npx prisma db push

# 3. 重新生成客户端
npx prisma generate
```

### 数据清理
```bash
# 运行迁移脚本
npx tsx scripts/migrate-to-deduplication.ts
```

### 测试验证
```bash
# 运行去重测试
npx tsx scripts/test-deduplication.ts

# 启动开发服务器测试
npm run dev
```

## 📊 风险评估与缓解

### 高风险项目 🔴
**无**

### 中风险项目 🟡
1. **API接口更新**
   - 风险：可能影响现有功能
   - 缓解：保持向后兼容，充分测试

2. **数据清理**
   - 风险：数据丢失
   - 缓解：开发环境操作，有备份

### 低风险项目 🟢
1. **工具库开发**
2. **前端组件更新**
3. **测试脚本**

## 🔄 回滚方案

### 数据库回滚
```bash
# 1. 回滚到之前的迁移
npx prisma migrate reset

# 2. 恢复备份数据（如果有）
# 手动操作
```

### 代码回滚
```bash
# 1. Git回滚到实施前的提交
git reset --hard <commit-hash>

# 2. 重新安装依赖
npm install

# 3. 重新生成Prisma客户端
npx prisma generate
```

## ✅ 验收标准

### 功能验收
- [ ] 新文件上传正常处理
- [ ] 重复文件正确去重
- [ ] 引用计数准确管理
- [ ] 文件删除正确处理
- [ ] 统计信息准确显示

### 性能验收
- [ ] 上传时间增加不超过20%
- [ ] 存储空间节省达到预期
- [ ] 数据库查询性能良好

### 兼容性验收
- [ ] 现有API接口正常工作
- [ ] 前端组件正常显示
- [ ] 用户体验无明显变化

## 📈 成功指标

1. **存储效率**：重复文件去重率 > 30%
2. **性能影响**：上传时间增加 < 20%
3. **稳定性**：无数据丢失或损坏
4. **用户体验**：上传成功率 > 99%

## 📞 支持联系

如遇到问题，请参考：
1. 错误日志：检查控制台输出
2. 数据库状态：使用 `npx prisma studio`
3. 文件系统：检查上传目录结构

---

**注意**：此计划基于开发环境，生产环境部署需要额外的安全措施和备份策略。
